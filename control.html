<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eW Launcher</title>
    <base href="https://enaon.github.io/iCat/">
    <style>
        :root {
            --color-primary: #BB86FC;
            --color-primary-variant: #3700B3;
            --color-secondary: #03DAC6;
            --color-background: #121212;
            --color-surface: #1E1E1E;
            --color-error: #CF6679;
            --color-on-primary: #000000;
            --color-on-secondary: #000000;
            --color-on-background: #FFFFFF;
            --color-on-surface: #FFFFFF;
            --color-on-error: #000000;
            --sidebar-width: 300px;
        }

        .skeleton {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            animation: skeleton-pulse 1.5s ease-in-out infinite;
        }

        @keyframes skeleton-pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background-color: var(--color-background);
            color: var(--color-on-background);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background-color: var(--color-surface);
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 100;
            flex-shrink: 0;
            min-height: 50px;
        }

        h1 {
            font-size: 18px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        h1 i {
            color: var(--color-primary);
        }

        .btn {
            background-color: var(--color-primary);
            color: var(--color-on-primary);
            border: none;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background-color: var(--color-surface);
            color: var(--color-on-surface);
        }

        .status {
            display: none;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--color-error);
        }

        .status-dot.connected {
            background-color: #4CAF50;
        }

        main {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        #sidebar {
            width: var(--sidebar-width);
            background-color: var(--color-surface);
            padding: 16px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 10;
            transition: transform 0.3s ease;
            overflow-y: auto;
        }

        #sidebar.hidden {
            transform: translateX(calc(-1 * var(--sidebar-width)));
        }

        #appFrame {
            flex: 1;
            border: none;
            background-color: var(--color-background);
            width: 100%;
            height: 100%;
        }

        .app-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .app-item {
            padding: 12px 16px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .app-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .app-item.active {
            background-color: var(--color-primary-variant);
            color: var(--color-on-background);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.7;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--color-primary);
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--color-primary);
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
            margin-left: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .menu-toggle {
            display: block;
            background: none;
            border: none;
            color: var(--color-on-surface);
            font-size: 20px;
            cursor: pointer;
            margin-right: 12px;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 5;
            display: none;
        }

        .overlay.visible {
            display: block;
        }

        .frame-selector {
            position: absolute;
            top: 8px;
            left: 8px;
            z-index: 90;
            background-color: var(--color-primary);
            color: var(--color-on-primary);
            border: none;
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .current-app-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 12px;
            font-size: 12px;
        }

        #sidebar {
            width: 80%;
            max-width: 300px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
        }

        #sidebar:not(.hidden)+.overlay {
            display: block;
        }

        .header-buttons {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn {
            padding: 6px 12px;
            font-size: 12px;
        }

        .header-title {
            margin-left: 12px;
            margin-right: auto;
            font-size: 18px;
            font-weight: 500;
        }

        @media (min-width: 769px) {
            #sidebar {
                width: 300px;
            }
        }
        
        /* Νέο στυλ για το animation φόρτωσης */
        .connecting-animation {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            flex-direction: column;
            gap: 20px;
        }
        
        .connecting-dots {
            display: flex;
            gap: 8px;
        }
        
        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--color-primary);
            animation: dot-pulse 1.5s infinite ease-in-out;
        }
        
        .dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes dot-pulse {
            0%, 100% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <header>
        <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>

        <h1 class="header-title">eW</h1>

        <div class="header-buttons">
            <div class="current-app-indicator" id="currentAppIndicator">
                <div class="status-dot" id="statusDotHeader"></div>
                <span id="statusTextHeader">-</span>
            </div>

            <button id="connectBtn" class="btn">
                <i class="fas fa-bluetooth-b"></i> Σύνδεση
            </button>
        </div>
    </header>

    <div class="status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Δεν έχετε συνδεθεί με Espruino</span>
    </div>

    <button class="frame-selector" id="frameSelector">
        <i class="fas fa-th-large"></i> Επιλογή App
    </button>

    <main>
        <aside id="sidebar" class="hidden">
            <div id="appList" class="app-list">
                <div class="empty-state">
                    <i class="fas fa-plug"></i>
                    <p>Συνδεθείτε για να φορτώσετε apps</p>
                </div>
            </div>
        </aside>

        <div class="overlay" id="overlay"></div>

        <iframe id="appFrame" src="about:blank"></iframe>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Στοιχεία DOM
            const connectBtn = document.getElementById('connectBtn');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const appList = document.getElementById('appList');
            const appFrame = document.getElementById('appFrame');
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const frameSelector = document.getElementById('frameSelector');

            // Νέα στοιχεία DOM για την ένδειξη στο header
            const statusDotHeader = document.getElementById('statusDotHeader');
            const statusTextHeader = document.getElementById('statusTextHeader');

            let isConnected = false;
            let currentDevice = null;
            let uartService = null;
            let uartRxCharacteristic = null;
            let uartTxCharacteristic = null;
            let dataBuffer = '';

            // Μεταβλητές για swipe
            let touchStartX = 0;
            let touchStartY = 0;
            let sidebarVisible = false;

            // Νέες μεταβλητές για ουρά εντολών
            let commandQueue = [];
            let isProcessingQueue = false;

            let isFirstLoad = true;
            let currentApp = null; // Αποθήκευση του τρέχοντος app

            // Εκκίνηση Web Bluetooth
            if (!navigator.bluetooth) {
                statusText.textContent = 'Το Web Bluetooth δεν υποστηρίζεται από αυτό το browser';
                statusTextHeader.textContent = 'No WebBT';
                connectBtn.disabled = true;
            }

            // Χειρισμός menu toggle
            menuToggle.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', hideSidebar);
            frameSelector.addEventListener('click', toggleSidebar);

            // Προσθήκη event listeners για swipe
            document.addEventListener('touchstart', handleTouchStart, false);
            document.addEventListener('touchmove', handleTouchMove, false);
            document.addEventListener('touchend', handleTouchEnd, false);

            // Ανακατάταξη του ύψους όταν αλλάζει το μέγεθος του παραθύρου
            window.addEventListener('resize', updateAppFrameHeight);

            // Αρχικοποίηση του ύψους του iframe
            updateAppFrameHeight();

            window.addEventListener('message', function(event) {
                if (event.data.type === 'BLUETOOTH_COMMAND') {
                    console.log("Launcher received command from app:", event.data.command);
                    addToCommandQueue(event.data.command);
                }
            });

            // UUIDs για την UART υπηρεσία του Espruino
            const UART_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
            const UART_RX_CHARACTERISTIC_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
            const UART_TX_CHARACTERISTIC_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

            // Έλεγχος αν το Web Bluetooth είναι διαθέσιμο
            if (!navigator.bluetooth) {
                statusText.textContent = 'Το Web Bluetooth δεν υποστηρίζεται από αυτό το browser';
                statusTextHeader.textContent = 'No WebBT';
                connectBtn.disabled = true;
            }

            // Εκκίνηση Web Bluetooth
            connectBtn.addEventListener('click', function() {
                if (isConnected) {
                    disconnectDevice();
                }
                else {
                    connectToDevice();
                }
            });

            // Σύνδεση με συσκευή
            async function connectToDevice() {
                try {
                    // Επαναφορά του iframe πριν από σύνδεση

                    statusText.textContent = 'Αναζήτηση συσκευών Bluetooth...';
                    statusTextHeader.textContent = 'Αναζήτηση...';

                    currentDevice = await navigator.bluetooth.requestDevice({
                        filters: [{ namePrefix: 'eW' }],
                        optionalServices: [UART_SERVICE_UUID]
                    });

                    if (!currentDevice) {
                        statusText.textContent = 'Δεν επιλέχθηκε συσκευή';
                        statusTextHeader.textContent = 'Δεν επιλέχθηκε';
                        return;
                    }

                    statusText.textContent = 'Σύνδεση με ' + currentDevice.name + '...';
                    statusTextHeader.textContent = 'Σύνδεση...';
                    const server = await currentDevice.gatt.connect();

                    uartService = await server.getPrimaryService(UART_SERVICE_UUID);
                    uartRxCharacteristic = await uartService.getCharacteristic(UART_RX_CHARACTERISTIC_UUID);
                    uartTxCharacteristic = await uartService.getCharacteristic(UART_TX_CHARACTERISTIC_UUID);

                    await uartTxCharacteristic.startNotifications();
                    uartTxCharacteristic.addEventListener('characteristicvaluechanged', handleUartData);

                    isConnected = true;
                    statusDot.classList.add('connected');
                    statusDotHeader.classList.add('connected');
                    statusText.textContent = 'Συνδεδεμένοι με ' + currentDevice.name;
                    statusTextHeader.textContent = 'Συνδεδεμένοι';
                    connectBtn.innerHTML = '<i class="fas fa-bluetooth-b"></i> Αποσύνδεση';

                    currentDevice.addEventListener('gattserverdisconnected', onDisconnected);

                    // Μικρή καθυστέρηση πριν την πρώτη εντολή
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    // ΑΥΤΟΜΑΤΗ ΣΑΡΩΣΗ ΜΟΛΙΣ ΣΥΝΔΕΘΟΥΜΕ
                    await scanForApps();

                }
                catch (error) {
                    console.error('Σφάλμα σύνδεσης:', error);
                    statusText.textContent = 'Σφάλμα σύνδεσης: ' + error.message;
                    statusTextHeader.textContent = 'Σφάλμα σύνδεσης';
                }
            }

            // Σάρωση για εφαρμογές στο Espruino
            async function scanForApps() {
                if (!isConnected) return;

                try {
                    statusText.innerHTML = 'Σάρωση για εφαρμογές... <span class="loading-spinner"></span>';
                    statusTextHeader.textContent = 'Σάρωση...';
                    appList.innerHTML = `
                    <div class="app-item" style="opacity: 0.5;"><div class="skeleton" style="width: 80%; height: 1.2em;"></div></div>
                    <div class="app-item" style="opacity: 0.5;"><div class="skeleton" style="width: 60%; height: 1.2em;"></div></div>
                    <div class="app-item" style="opacity: 0.5;"><div class="skeleton" style="width: 70%; height: 1.2em;"></div></div>
                    `;

                    // 1. Πάρε τη λίστα με τα ΟΝΟΜΑΤΑ των εγκατεστημένων εφαρμογών (Object.keys(ew.apps))
                    dataBuffer = ''; // Clear buffer πριν την νέα αίτηση
                    const commandToSend = 'Bluetooth.println(JSON.stringify(Object.keys(ew.apps)));\n';
                    console.log("Στέλνω εντολή:", commandToSend);
                    await sendCommand(commandToSend);

                }
                catch (error) {
                    console.error('Σφάλμα σάρωσης:', error);
                    statusText.textContent = 'Σφάλμα σάρωσης: ' + error.message;
                    statusTextHeader.textContent = 'Σφάλμα σάρωσης';
                }
            }

            // ΣΥΣΤΗΜΑ ΟΥΡΑΣ ΕΝΤΟΛΩΝ
            function addToCommandQueue(command) {
                commandQueue.push(command);
                if (!isProcessingQueue) {
                    processCommandQueue();
                }
            }

            async function processCommandQueue() {
                if (commandQueue.length === 0) {
                    isProcessingQueue = false;
                    return;
                }

                isProcessingQueue = true;
                const command = commandQueue[0];

                try {
                    await sendCommandDirect(command);
                    commandQueue.shift();
                }
                catch (error) {
                    console.error("Σφάλμα αποστολής εντολής, προσπαθώ ξανά:", error);
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                if (commandQueue.length > 0) {
                    setTimeout(processCommandQueue, 50);
                }
                else {
                    isProcessingQueue = false;
                }
            }

            // Αποστολή εντολής απευθείας στη συσκευή (χωρίς ουρά)
            async function sendCommandDirect(command) {
                if (!uartRxCharacteristic) {
                    console.error("Δεν υπάρχει σύνδεση UART");
                    throw new Error("No UART connection");
                }

                try {
                    console.log("Αποστολή εντολής:", command);
                    const encoder = new TextEncoder();
                    const data = encoder.encode(command);
                    await uartRxCharacteristic.writeValue(data);
                }
                catch (error) {
                    console.error("Σφάλμα αποστολής εντολής:", error);
                    throw error;
                }
            }

            // ΠΑΛΙΑ ΣΥΝΑΡΤΗΣΗ sendCommand (για πίσω συμβατότητα)
            async function sendCommand(command) {
                return sendCommandDirect(command);
            }

            // Χειρισμός εισερχόμενων δεδομένων από UART
            function handleUartData(event) {
                const value = event.target.value;
                const decoder = new TextDecoder();
                const rawData = decoder.decode(value);

                console.log("Launcher received RAW:", rawData);

                // 1. ΠΡΟΩΘΗΣΗ: Στείλε ΟΛΑ τα RAW δεδομένα στο τρέχον iframe (app)
                if (appFrame && appFrame.contentWindow) {
                    appFrame.contentWindow.postMessage({
                        type: 'BLUETOOTH_RAW_DATA',
                        data: rawData
                    }, '*');
                }

                // 2. ΕΠΕΞΕΡΓΑΣΙΑ ΓΙΑ ΤΟΝ LAUNCHER:
                dataBuffer += rawData;

                // Έλεγχος αν το buffer περιέχει την απάντηση για τα apps
                try {
                    const jsonStart = dataBuffer.indexOf('[');
                    const jsonEnd = dataBuffer.lastIndexOf(']');

                    if (jsonStart >= 0 && jsonEnd > jsonStart) {
                        const jsonString = dataBuffer.substring(jsonStart, jsonEnd + 1);
                        const jsonData = JSON.parse(jsonString);

                        // ΕΛΕΓΧΟΣ: Είναι array και όλα τα items είναι strings?
                        if (Array.isArray(jsonData) && jsonData.every(item => typeof item === 'string')) {
                            console.log("Επιτυχής ανάλυση λίστας apps:", jsonData);
                            dataBuffer = '';
                            processAppsObject(jsonData);
                        }
                    }
                }
                catch (e) {
                    console.log("Λήψη μερικών δεδομένων... (Δεν ήταν λίστα apps)");
                }

                // Αποκοπή buffer αν γίνει πολύ μεγάλο
                if (dataBuffer.length > 1024) {
                    console.warn("Buffer μεγάλο, αποκοπή");
                    dataBuffer = '';
                }
            }

            // Επεξεργασία λίστας εφαρμογών
            function processAppList(appArray) {
                const appObject = {};
                appArray.forEach(appName => {
                    appObject[appName] = true;
                });
                processAppsObject(appObject);
            }

            // Επεξεργασία αντικειμένου εφαρμογών
            function processAppsObject(appsObject) {
                let appNames = [];
                if (Array.isArray(appsObject) && appsObject.every(item => typeof item === 'string')) {
                    appNames = appsObject;
                }
                else if (typeof appsObject === 'object' && appsObject !== null) {
                    appNames = Object.keys(appsObject);
                }
                else {
                    console.error("Μη αναμενόμενο format apps:", appsObject);
                    return;
                }

                statusText.textContent = `Βρέθηκαν ${appNames.length} εφαρμογές`;
                statusTextHeader.textContent = `Βρέθηκαν ${appNames.length} apps`;

                if (appNames.length === 0) {
                    appList.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Δεν βρέθηκαν εφαρμογές στο Espruino</p></div>';
                    statusTextHeader.textContent = '0 apps';
                    return;
                }

                // Έλεγχος για κάθε εφαρμογή αν υπάρχει το αντίστοιχο web app
                checkAppsExistence(appNames);
            }

            // Έλεγχος ύπαρξης HTML για κάθε app
            async function checkAppsExistence(appNames) {
                const availableApps = [];

                for (const appName of appNames) {
                    try {
                        const response = await fetch(`../app/${appName}/index.html`);
                        if (response.ok) {
                            availableApps.push(appName);
                        }
                    }
                    catch (e) {
                        // Το app δεν υπάρχει, αγνοούμε
                    }
                }

                // Εμφάνιση των διαθέσιμων εφαρμογών
                displayAvailableApps(availableApps);
            }

            // Εμφάνιση λίστας διαθέσιμων εφαρμογών
            function displayAvailableApps(apps) {
                if (apps.length === 0) {
                    appList.innerHTML = '<div class="empty-state"><i class="fas fa-folder-open"></i><p>Δεν βρέθηκαν αντίστοιχα web apps. Βεβαιωθείτε ότι βρίσκονται στο φάκελο ../app/[όνομα]/index.html</p></div>';
                    statusText.textContent = 'Δεν βρέθηκαν web apps για τις εφαρμογές του Espruino';
                    statusTextHeader.textContent = '0 web apps';
                    return;
                }

                statusText.textContent = `Βρέθηκαν ${apps.length} web apps`;
                statusTextHeader.textContent = `${apps.length} web apps`;
                appList.innerHTML = '';

                apps.forEach(app => {
                    const appItem = document.createElement('div');
                    appItem.className = 'app-item';
                    appItem.textContent = app;
                    appItem.addEventListener('click', () => {
                        loadApp(app);
                        hideSidebar();
                    });
                    appList.appendChild(appItem);
                });

                // ΕΠΙΛΟΓΗ DEFAULT ΕΦΑΡΜΟΓΗΣ & ΑΥΤΟΜΑΤΗ ΦΟΡΤΩΣΗ
                let defaultAppName = null;
                if (apps.includes('itag')) {
                    defaultAppName = 'itag';
                }
                else if (apps.includes('timer')) {
                    defaultAppName = 'timer';
                }
                else {
                    defaultAppName = apps[0];
                }

                // Φόρτωση της default εφαρμογής
                if (defaultAppName) {
                    loadApp(defaultAppName);
                }
            }

            // Φόρτωση εφαρμογής στο iframe
            function loadApp(appName) {
                // Αποθήκευση του τρέχοντος app
                currentApp = appName;
                
                // Highlight την επιλεγμένη εφαρμογή
                document.querySelectorAll('.app-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.textContent === appName) {
                        item.classList.add('active');
                    }
                });

                // Φόρτωση της εφαρμογής στο iframe
                appFrame.src = `../app/${appName}/index.html`;
                statusText.textContent = `Φόρτωση: ${appName}`;
                statusTextHeader.textContent = `Φόρτωση: ${appName}`;

                // Άδειασμα του buffer μηνύσεων πριν φορτωθεί νέο app
                dataBuffer = '';

                // Όταν το iframe φορτωθεί, στείλ'του ένα μήνυμα "handshake"
                appFrame.onload = function() {
                    statusText.textContent = `Τρέχει: ${appName}`;
                    statusTextHeader.textContent = `Τρέχει: ${appName}`;
                    let firstCommand = `Bluetooth.println(JSON.stringify(ew.apps.${appName}.state.def));\n`;
                    console.log(`Launcher sending first command to ${appName}:`, firstCommand);
                    addToCommandQueue(firstCommand);

                    try {
                        appFrame.contentWindow.postMessage({
                            type: 'LAUNCHER_INFO',
                            message: 'App loaded successfully. First command sent.'
                        }, '*');
                    }
                    catch (e) {
                        console.log("Could not post message to iframe:", e);
                    }

                    setTimeout(updateAppFrameHeight, 100);
                };
            }

            // Αποσύνδεση από συσκευή
            function disconnectDevice() {
                if (currentDevice && currentDevice.gatt.connected) {
                    currentDevice.gatt.disconnect();
                }
                onDisconnected();
            }

 

            // Χειρισμός αποσύνδεσης
function onDisconnected() {
    console.log("onDisconnected called");
    
    isConnected = false;
    statusDot.classList.remove('connected');
    statusDotHeader.classList.remove('connected');
    statusText.textContent = 'Αποσυνδεθήκατε από τη συσκευή';
    statusTextHeader.textContent = 'Αποσυνδεθήκατε';
    connectBtn.innerHTML = '<i class="fas fa-bluetooth-b"></i> Σύνδεση';
    
    // ΑΠΕΝΕΡΓΟΠΟΙΗΣΗ ΤΟΥ IFRAME - ΣΩΣΤΗ ΕΚΔΟΣΗ
    appFrame.onload = null;
    appFrame.src = 'about:blank'; // Αδειάζουμε το iframe
    
    // ΕΠΑΝΑΦΟΡΑ ΤΗΣ ΑΡΧΙΚΗΣ ΚΑΤΑΣΤΑΣΗΣ
    appList.innerHTML = `
        <div class="empty-state">
            <i class="fas fa-plug"></i>
            <p>Συνδεθείτε για να φορτώσετε apps</p>
        </div>
    `;

    // ΕΠΙΣΤΡΟΦΗ ΣΤΗΝ ΑΡΧΙΚΗ ΣΕΛΙΔΑ
    showSidebar();

    // Καθαρισμός των μεταβλητών σύνδεσης
    currentDevice = null;
    uartService = null;
    uartRxCharacteristic = null;
    uartTxCharacteristic = null;
    dataBuffer = '';

    // Καθαρισμός ουράς εντολών
    commandQueue = [];
    isProcessingQueue = false;
    
    // Επαναφορά του currentApp
    currentApp = null;
}

            // Συναρτήσεις για το sidebar
            function toggleSidebar() {
                if (sidebar.classList.contains('hidden')) {
                    showSidebar();
                }
                else {
                    hideSidebar();
                }
            }

            function showSidebar() {
                sidebar.classList.remove('hidden');
                overlay.classList.add('visible');
                sidebarVisible = true;
            }

            function hideSidebar() {
                sidebar.classList.add('hidden');
                overlay.classList.remove('visible');
                sidebarVisible = false;
            }

            // Συναρτήσεις για swipe
            function handleTouchStart(evt) {
                const firstTouch = evt.touches[0];
                touchStartX = firstTouch.clientX;
                touchStartY = firstTouch.clientY;
            }

            function handleTouchMove(evt) {
                if (!touchStartX || !touchStartY) return;

                const touchX = evt.touches[0].clientX;
                const touchY = evt.touches[0].clientY;

                const diffX = touchX - touchStartX;
                const diffY = touchY - touchStartY;

                if (Math.abs(diffX) > Math.abs(diffY) && diffX > 50 && touchStartX < 50) {
                    showSidebar();
                }
            }

            function handleTouchEnd() {
                touchStartX = 0;
                touchStartY = 0;
            }

            // Συνάρτηση για να ενημερώνει το ύψος του iframe
            function updateAppFrameHeight() {
                const headerHeight = document.querySelector('header').offsetHeight;
                const mainElement = document.querySelector('main');

                const availableHeight = window.innerHeight - headerHeight;

                mainElement.style.height = availableHeight + 'px';
                appFrame.style.height = '100%';

                console.log('Updated iframe height:', availableHeight);
            }

            // Το sidebar είναι ανοιχτό στην πρώτη φόρτωση
            function checkScreenSize() {
                if (isFirstLoad) {
                    sidebar.classList.remove('hidden');
                    overlay.classList.remove('visible');
                    isFirstLoad = false;
                }
            }
            
            // Έλεγχος μεγέθους οθόνης κατά τη φόρτωση και αλλαγή μεγέθους
            window.addEventListener('load', checkScreenSize);
            window.addEventListener('resize', checkScreenSize);
            checkScreenSize();
        });
    </script>
</body>
</html>